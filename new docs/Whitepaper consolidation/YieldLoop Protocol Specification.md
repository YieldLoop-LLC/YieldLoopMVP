# YieldLoop Protocol Specification
**Version:** v1.2  
**Status:** Canonical / Source of Truth  
**Audience:** Auditors, Core Developers, Reviewers  
**Chain:** BNB Chain (v1.2)

---

## 1. Purpose and Design Philosophy

YieldLoop is an automated vault-based trading protocol designed to generate realized trading profit while avoiding common failure modes found in pooled, projection-based, or emission-driven DeFi systems.

The protocol is built on the following principles:

- **Realized profit only** — no mark-to-market profit credit
- **Vault isolation** — no pooled user funds
- **Deterministic execution** — behavior bound to state machines and approved strategies
- **Fail-closed design** — when unsafe, the system stops
- **No forced risk recovery** — losses are accepted, not hidden
- **Optional receipt token (LOOP)** — representing realized profit only

YieldLoop prioritizes survivability and auditability over growth, leverage, or yield maximization.

---

## 2. Core System Invariants (Hard Rules)

The following rules are **non-negotiable** and must be enforced at the smart contract level.

- User funds are never pooled
- Vaults are isolated per user
- Trading may only occur in explicitly permitted vault states
- Profit is credited only after settlement
- Profit is always denominated in USDT
- Performance fees apply only to realized profit
- No fees are charged on losses
- Principal may only be withdrawn after vault closeout
- LOOP cannot be minted without realized profit
- LOOP supply must always be solvent against its redemption pool
- Governance and admin roles cannot seize user funds
- Emergency actions cannot alter accounting outcomes

Any implementation violating these rules is considered protocol-breaking.

---

## 3. Vault Architecture and Isolation Model

### 3.1 Vault Structure

Each YieldLoop vault is an independent smart contract instance with:

- Single owner
- Single base asset (whitelisted)
- Independent ledger
- Independent state machine
- Independent execution lifecycle

There are **no shared balances**, **no pooled risk**, and **no cross-vault dependencies**.

### 3.2 Supported Assets (v1.2)

Only the following BEP-20 assets may be used as vault base assets:

- BTCB
- ETH
- SOL
- XRP
- BNB
- USDT

Any attempt to deposit or route through non-whitelisted assets must revert.

---

## 4. Vault State Machine (Authoritative)

Each vault exists in exactly one state at all times.

### 4.1 State Enumeration

| ID | State Name |
|----|-----------|
| 0 | VAULT_CREATED |
| 1 | DEPOSIT_PENDING |
| 2 | FUNDED_IDLE |
| 3 | STRATEGY_PROPOSED |
| 4 | STRATEGY_APPROVED |
| 5 | EXECUTING |
| 6 | HOLDING_POSITION |
| 7 | SETTLEMENT_PENDING |
| 8 | PROFIT_CREDITED |
| 9 | WITHDRAW_PROFIT_PENDING |
| 10 | CLOSE_REQUESTED |
| 11 | CLOSE_PENDING |
| 12 | CLOSED |
| 13 | PAUSED |
| 14 | ERROR_LOCK |

---

### 4.2 Execution Permission Rule

**Trades and swaps may only occur when vault.state ∈ { EXECUTING, CLOSE_PENDING }.**

Any attempt to trade in any other state must revert.

---

### 4.3 Valid State Transitions

#### Deposit Flow
- VAULT_CREATED → DEPOSIT_PENDING → FUNDED_IDLE

#### Strategy Flow
- FUNDED_IDLE → STRATEGY_PROPOSED
- STRATEGY_PROPOSED → STRATEGY_APPROVED
- STRATEGY_PROPOSED → FUNDED_IDLE (rejected/expired)

#### Execution Flow
- STRATEGY_APPROVED → EXECUTING
- EXECUTING → HOLDING_POSITION
- HOLDING_POSITION → EXECUTING
- EXECUTING → SETTLEMENT_PENDING
- SETTLEMENT_PENDING → PROFIT_CREDITED
- PROFIT_CREDITED → FUNDED_IDLE

#### Profit Withdrawal
- PROFIT_CREDITED → WITHDRAW_PROFIT_PENDING → PROFIT_CREDITED

#### Closeout Flow
- FUNDED_IDLE / PROFIT_CREDITED / HOLDING_POSITION → CLOSE_REQUESTED
- CLOSE_REQUESTED → CLOSE_PENDING
- CLOSE_PENDING → CLOSED

#### Pause / Failure
- ANY → PAUSED
- PAUSED → FUNDED_IDLE
- ANY → ERROR_LOCK
- ERROR_LOCK → FUNDED_IDLE (admin recovery)

Illegal transitions must revert.

---

## 5. Strategy Generation and Approval

### 5.1 Strategy Object

All trading behavior is bound to a **Strategy Object** generated by the protocol and approved by the user.

A strategy defines:

- Strategy type (e.g. spread capture, DEX arbitrage)
- Allowed venues
- Routing constraints
- Trade sizing rules
- Slippage, impact, and liquidity thresholds
- Execution limits
- Oracle validation rules
- Expiration timestamp

### 5.2 User Approval Requirement

- No strategy may execute without explicit user approval
- Strategies are hash-bound
- Execution must revert if the approved hash does not match
- Strategies expire automatically to prevent stale execution

---

## 6. Execution Engine Behavior

### 6.1 Allowed Venues (v1.2)

Execution is strictly limited to:

- PancakeSwap
- BiSwap

No third venue routing is permitted.

### 6.2 Trade Quality Gate

Trades may execute only if all conditions pass:

- Expected net profit ≥ minimum threshold
- Slippage ≤ max slippage
- Price impact ≤ max impact
- Pool liquidity ≥ minimum liquidity
- Gas costs within buffer
- Oracle price valid and fresh

Failure of any condition results in trade rejection, not degradation.

---

## 7. Settlement and Profit Credit (High-Level)

Settlement is a deterministic phase following any completed trade cycle.

- Profit is realized only after positions are closed
- Profit is computed strictly from settlement balances
- Unrealized P&L is never credited
- Losses reduce principal
- No recovery trading is attempted

Detailed accounting rules are defined in **Document 2: Accounting & Value Integrity Specification**.

---

## 8. LOOP Receipt Token (Canonical Model)

### 8.1 Definition

LOOP is a **mint-and-burn receipt token** representing realized net trading profit.

LOOP is:
- Not an emission token
- Not inflationary
- Not speculative
- Not required to use YieldLoop

### 8.2 Minting Rules

LOOP may be minted only when all of the following are true:

- A trade cycle has closed
- Settlement has completed
- Net realized profit exists
- Performance fees have been deducted
- User has selected LOOP payout mode

LOOP is minted **1:1 against USDT** allocated to the LOOP Redemption Pool.

### 8.3 Burning and Redemption

- LOOP may be redeemed at any time
- Redemption burns LOOP
- Equivalent USDT is transferred from the Redemption Pool

### 8.4 Solvency Invariant

At all times:

Total LOOP Supply ≤ LOOP Redemption Pool USDT Balance

Any action violating this invariant must revert.

---

## 9. Failure Modes and Emergency Behavior

YieldLoop is designed to **fail closed**, not fail open.

### 9.1 General Rule

When unsafe:
- Trading stops
- Accounting freezes
- Withdrawals remain available where safe

### 9.2 Failure Triggers

- Oracle stale or invalid
- Excessive slippage
- Liquidity collapse
- Repeated transaction failures
- DEX outage
- Gas price spikes
- Admin emergency pause

### 9.3 Emergency Actions

Admins may immediately:
- Pause trading
- Pause new deposits
- Trigger kill switch

Admins may **never**:
- Move user funds
- Mint LOOP
- Change accounting
- Override settlement outcomes

---

## 10. Governance and Administrative Controls

### 10.1 Governance Model

- Multisignature Admin Council
- Timelocked execution for sensitive actions
- No on-chain token voting in v1.2

### 10.2 Timelock

- Minimum delay: 72 hours
- Recommended delay: 96 hours

All sensitive actions must be queued and observable.

### 10.3 Immutable Invariants

The following cannot be changed by governance or upgrade:

- Realized-profit-only accounting
- LOOP mint/burn rules
- Redemption pool solvency
- No forced liquidation
- No fees on losses
- Vault isolation

---

## 11. Security and Trust Assumptions

YieldLoop assumes:

- Smart contracts may contain bugs
- Markets may behave adversarially
- Oracles may fail
- Execution may be front-run

The protocol responds by **stopping**, not compensating.

YieldLoop makes no guarantees of profit.

---

## 12. Canonical Authority Statement

This document is the **authoritative definition** of YieldLoop protocol behavior.

If any other document conflicts with this specification, **this document prevails**.

---

END OF DOCUMENT
